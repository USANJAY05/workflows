name: Count Lines in All Repos

on:
  schedule:
    - cron: "0 0 * * 1" # Runs every Monday at midnight UTC
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write  # âœ… Allows pushing changes to the repo

jobs:
  count-lines:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # Disable default token handling

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Fetch all repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh repo list usanjay05 --json name -q '.[].name' > repos.txt

      - name: Count lines in each repository
        run: |
          echo "# Repository Line Counts" > repo-line-counts.md
          while IFS= read -r repo; do
              echo "Processing $repo..."
              git clone --depth 1 "https://github.com/usanjay05/$repo.git"
              cd "$repo"
              total_lines=$(git ls-files | xargs wc -l | tail -n 1)
              echo "$repo: $total_lines" >> ../repo-line-counts.md
              cd ..
              rm -rf "$repo"
          done < repos.txt

      - name: Commit and Push Updated Line Counts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add repo-line-counts.md
          git commit -m "Updated repository line counts"
          git push https://x-access-token:${GH_TOKEN}@github.com/usanjay05/workflows.git main
        continue-on-error: true
